import React from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  Modal,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { usePremium } from '../hooks/usePremium';

interface PremiumFeatureWrapperProps {
  featureId: string;
  children: React.ReactNode;
  fallback?: React.ReactNode;
  showUpgradePrompt?: boolean;
}

export const PremiumFeatureWrapper: React.FC<PremiumFeatureWrapperProps> = ({
  featureId,
  children,
  fallback,
  showUpgradePrompt = true,
}) => {
  const { hasFeature, isPremium } = usePremium();
  const [showUpgradeModal, setShowUpgradeModal] = React.useState(false);

  if (hasFeature(featureId)) {
    return <>{children}</>;
  }

  if (fallback) {
    return <>{fallback}</>;
  }

  return (
    <>
      <TouchableOpacity
        style={styles.premiumOverlay}
        onPress={() => showUpgradePrompt && setShowUpgradeModal(true)}
        disabled={!showUpgradePrompt}
      >
        <View style={styles.premiumContent}>
          <Ionicons name='diamond' size={24} color='#007AFF' />
          <Text style={styles.premiumText}>Premium Feature</Text>
          {showUpgradePrompt && (
            <Text style={styles.upgradeText}>Tap to upgrade</Text>
          )}
        </View>
      </TouchableOpacity>

      <Modal
        visible={showUpgradeModal}
        transparent={true}
        animationType='slide'
        onRequestClose={() => setShowUpgradeModal(false)}
        accessible={false}
        accessibilityLabel="Modal"
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContainer}>
            <View style={styles.modalHeader}>
              <Ionicons name='diamond' size={32} color='#007AFF' />
              <Text style={styles.modalTitle}>Upgrade to Premium</Text>
              <TouchableOpacity
                onPress={() => setShowUpgradeModal(false)}
                style={styles.closeButton}
              >
                <Ionicons name='close' size={24} color='#666' />
              </TouchableOpacity>
            </View>

            <View style={styles.modalContent}>
              <Text style={styles.modalDescription}>
                Unlock this premium feature and many more with a Thoughtmarks Premium subscription.
              </Text>
              <View style={styles.featureList}>
                <View style={styles.featureItem}>
                  <Ionicons name='checkmark-circle' size={20} color='#34c759' />
                  <Text style={styles.featureText}>Unlimited AI insights</Text>
                </View>
                <View style={styles.featureItem}>
                  <Ionicons name='checkmark-circle' size={20} color='#34c759' />
                  <Text style={styles.featureText}>Advanced voice transcription</Text>
                </View>
                <View style={styles.featureItem}>
                  <Ionicons name='checkmark-circle' size={20} color='#34c759' />
                  <Text style={styles.featureText}>Priority support</Text>
                </View>
                <View style={styles.featureItem}>
                  <Ionicons name='checkmark-circle' size={20} color='#34c759' />
                  <Text style={styles.featureText}>Unlimited storage</Text>
                </View>
              </View>
            </View>

            <TouchableOpacity
              style={styles.upgradeButton}
              onPress={() => {
                setShowUpgradeModal(false);
                // Navigate to premium screen
              }}
            >
              <Text style={styles.upgradeButtonText}>Upgrade Now</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>
    </>
  );
};

const styles = StyleSheet.create({
  premiumOverlay: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    backgroundColor: 'rgba(255, 255, 255, 0.9)',
  },
  premiumContent: {
    alignItems: 'center',
    justifyContent: 'center',
    flex: 1,
  },
  premiumText: {
    marginTop: 8,
    fontSize: 16,
    fontWeight: '600',
  },
  upgradeText: {
    marginTop: 4,
    fontSize: 12,
    color: '#007AFF',
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.5)',
    alignItems: 'center',
    justifyContent: 'center',
  },
  modalContainer: {
    width: '90%',
    backgroundColor: '#fff',
    borderRadius: 12,
    padding: 16,
  },
  modalHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  modalTitle: { fontSize: 18, fontWeight: '700' },
  closeButton: { padding: 8 },
  modalContent: { marginTop: 12 },
  modalDescription: { fontSize: 14, color: '#333', marginBottom: 12 },
  featureList: { gap: 8 },
  featureItem: { flexDirection: 'row', alignItems: 'center', gap: 8 },
  featureText: { fontSize: 14 },
  upgradeButton: {
    marginTop: 16,
    backgroundColor: '#007AFF',
    paddingVertical: 12,
    borderRadius: 8,
    alignItems: 'center',
  },
  upgradeButtonText: { color: '#fff', fontWeight: '600' },
});
